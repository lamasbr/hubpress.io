<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[Anotações para não esquecer]]></title><description><![CDATA[Algumas anotações importantes (ou não) pra mim!]]></description><link>https://lamasbr.github.io</link><generator>RSS for Node</generator><lastBuildDate>Tue, 29 Aug 2017 08:02:57 GMT</lastBuildDate><atom:link href="https://lamasbr.github.io/rss/" rel="self" type="application/rss+xml"/><ttl>60</ttl><item><title><![CDATA[Instalando e configurando Samba + Squid + squidGuard  com autenticação transparente NTLM (Active Directory) no Ubuntu 16.04.3 LTS]]></title><description><![CDATA[<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Acredito que qualquer organização que deixe o acesso à internet totalmente liberado para os seus colaboradores, além de perder em produtividade, está perdendo dinheiro. Até porque, tempo é dinheiro.</p>
</div>
<div class="paragraph">
<p>Além disso, dependendo do ambiente da empresa, pode ser necessário filtrar o acesso dependendo do usuário, departamento e etc. Este é o caso da empresa onde atualmente trabalho e devido a largura de banda ser pequena somado à quantidade de dispositivos na rede e usuários acessando simultaneamente, foi necessário bloquear o acesso à maioria dos sites desnecessários ao desempenho do trabalho dos colaboradores.</p>
</div>
<div class="paragraph">
<p>Para você ter chegado até aqui, acredito que já tenha o conhecimento necessário para instalar e configurar o Ubunto, utilizar editores de texto, visualizar logs e etc., pois não abordarei essas questões.</p>
</div>
<div class="paragraph">
<p>Depois de muito procurar uma configuração que de fato funcionasse e precisei juntar informações de diversos sites, resolvi guardar e publicar aqui para que, caso eu precise novamente no futuro ou alguém que também esteja passando pela mesma dificuldade que passei, possa utilizar como fonte de consulta. Enfim, vamos ao que interessa.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_detalhando_o_ambiente">Detalhando o ambiente</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Domínio Active Directory: dominio.local</p>
</li>
<li>
<p>Servidor Active Directory: ad.dominio.local / IP: 10.0.0.1</p>
</li>
<li>
<p>Servidor Samba/proxy: proxy.dominio.local / IP: 10.0.0.2</p>
</li>
<li>
<p>Usuário Administrador do domínio: dominio\administrador</p>
</li>
<li>
<p>Senha do usuário administrador do domínio: 123456</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adicione_o_servidor_samba_no_dns_do_active_directory">Adicione o servidor Samba no DNS do Active Directory</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para que a comunicação entre o Samba/Winbind e o Active Directory ocorra sem problemas, é necessário que você adicione o seu servidor Samba no DNS do seu Active Directory.</p>
</div>
<div class="paragraph">
<p>No seu controlador de domínio (ad.dominio.local), abra o console de gerenciamento do DNS, expanda a 'zona de pesquisa direta' e adicione a entrada do tipo 'Novo Host (A ou AAAA)' informando o nome como 'proxy' e o IP como '10.0.0.2'. <strong>Deixe marcado a opção para criar o registro PTR</strong>.</p>
</div>
<div class="paragraph">
<p>&lt;INSERIR IMAGEM AQUI&gt;</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_atualizando_o_ubuntu">Atualizando o Ubuntu</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Antes de instalar qualquer pacote na sua distribuição, é necessário atualizar o repositório para garantir que os pacotes em sua ultima versão serão instalados corretamente e não irá gerar nenhum erro de dependência.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Atualize o Ubuntu com o comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@proxy~#: apt update ; apt upgrade</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_instalando_e_configurando_os_pacotes_b_sicos_e_necess_rios">Instalando e configurando os pacotes básicos e necessários</h3>
<div class="paragraph">
<p>Instale os pacotes necessários utilizando comando abaixo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@proxy~#: apt install squid squidguard telnet tcpdump ntpdate samba winbind vim tcpdump mc xz-utils rsync</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_edite_o_arquivo_etc_hosts">Edite o arquivo /etc/hosts</h4>
<div class="paragraph">
<p>Abra o arquivo /etc/hosts e ajuste o endereço do seu servidor proxy e seu servidor Active Directory nele:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>10.0.0.2	proxy.dominio.local	proxy
10.0.0.1	ad.dominio.local	ad</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_edite_o_arquivo_etc_samba_smb_conf">Edite o arquivo /etc/samba/smb.conf</h4>
<div class="paragraph">
<p>Abra o arquivo /etc/samba/smb.conf e deixe conforme a configuração abaixo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[global]
        unix charset = ISO-8859-1
        workgroup = DOMINIO
        server string = proxy
        netbios name = proxy
        log level = 5
        load printers = no
        log file = /var/log/samba/log.%m
        max log size = 500
        realm = DOMINIO.LOCAL
        security = ads
        auth methods = winbind
        password server = 10.0.0.1
        winbind separator = +
        encrypt passwords = yes
        printcap name = cups
        winbind cache time = 15
        winbind enum users = yes
        winbind enum groups = yes
        winbind use default domain = yes
        idmap uid = 10000-20000
        idmap gid = 10000-20000
        socket options = TCP_NODELAY SO_RCVBUF=8192 SO_SNDBUF=8192
        local master = no
        os level = 233
        domain master = no
        preferred master = no
        domain logons = no
        dns proxy = no
        ldap ssl = no
        printing = cups
        disable spoolss = yes
        show add printer wizard = no
        template shell = /bin/bash
        template homedir = /home/%U</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_inserindo_o_samba_no_dom_nio">Inserindo o Samba no domínio</h4>
<div class="paragraph">
<p>Insira o servidor Samba no domínio com o comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@proxy~#: net ads join -U dominio\administrador</code></pre>
</div>
</div>
<div class="paragraph">
<p>Insira a senha do administrador do domínio, neste exemplo é 123456.</p>
</div>
</div>
<div class="sect3">
<h4 id="_edite_o_arquivo_etc_init_d_winbind">Edite o arquivo /etc/init.d/winbind</h4>
<div class="paragraph">
<p>Modifique a linha 43 do arquivo /etc/init.d/winbind para que toda vez que inicie, modifique o grupo do diretório /var/run/samba/winbindd_privileged e /var/lib/samba/winbindd_privileged para root:proxy.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
No Ubuntu o usuário do Squid é 'proxy'.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">chown root:proxy $PIDDIR/winbindd_privileged/ || return 1
chown root:proxy /var/lib/samba/winbindd_privileged/ || return 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Altere a permissão do arquivo /usr/bin/ntlm_auth para que possa ser executado como root. Para isso, utilize o comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@proxy~#: chmod 6755 /usr/bin/ntlm_auth</code></pre>
</div>
</div>
<div class="paragraph">
<p>Então, reinicie o Samba e o Winbind com o comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@proxy~#: /etc/init.d/samba restart ; /etc/init.d/winbind restart</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testando_a_comunica_o_do_samba_winbind_com_o_servidor_active_directory">Testando a comunicação do Samba/Winbind com o servidor Active Directory</h3>
<div class="paragraph">
<p>Para assegurar que o seu servidor Samba/Winbind está comunicando perfeitamente com o servidor Active Directory, execute os comandos abaixo. Cada comando deverá retornar exatamente como exibido:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@proxy~#: wbinfo -t
checking the trust secret for domain DOMINIO via RPC calls succeeded</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@proxy~#: wbinfo -a administrador</code></pre>
</div>
</div>
<div class="paragraph">
<p>Será solicitada a senha do usuário administrador duas vezes e então deverá retornar a saída abaixo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>plaintext password authentication succeeded
challenge/response password authentication succeeded</code></pre>
</div>
</div>
<div class="paragraph">
<p>Caso tudo tenha ocorrido como esperado até aqui, prossiga para os próximos passos. Caso contrário, reveja as configurações pois algo pode ter passado despercebido ou algum arquivo ter sido configurado errado.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configurando_o_squid">Configurando o Squid</h3>
<div class="paragraph">
<p>A ESCREVER&#8230;&#8203;</p>
</div>
</div>
</div>
</div>]]></description><link>https://lamasbr.github.io/2017/08/29/How-to-install-Squid-squid-Guard-using-NTLM-transparent-auth-Active-Directory-on-Ubuntu-16043-LTS.html</link><guid isPermaLink="true">https://lamasbr.github.io/2017/08/29/How-to-install-Squid-squid-Guard-using-NTLM-transparent-auth-Active-Directory-on-Ubuntu-16043-LTS.html</guid><category><![CDATA[Linux]]></category><category><![CDATA[Ubuntu]]></category><category><![CDATA[Squid]]></category><category><![CDATA[Samba]]></category><category><![CDATA[squidGuard]]></category><category><![CDATA[NTLM]]></category><category><![CDATA[Active Directory]]></category><dc:creator><![CDATA[Lincoln Lamas]]></dc:creator><pubDate>Tue, 29 Aug 2017 00:00:00 GMT</pubDate></item></channel></rss>