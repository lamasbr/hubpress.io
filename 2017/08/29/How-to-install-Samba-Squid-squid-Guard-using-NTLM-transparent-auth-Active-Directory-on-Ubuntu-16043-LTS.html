<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Instalando e configurando Samba + Squid + squidGuard  com autenticação transparente NTLM (Active Directory) no Ubuntu 16.04.3 LTS</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://lamasbr.github.io/favicon.ico">

    <link rel="stylesheet" type="text/css" href="//lamasbr.github.io/themes/casper/assets/css/screen.css?v=1504037300184" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />

    <link rel="canonical" href="https://lamasbr.github.io/2017/08/29/How-to-install-Samba-Squid-squid-Guard-using-NTLM-transparent-auth-Active-Directory-on-Ubuntu-16043-LTS.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="Anotações para não esquecer" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Instalando e configurando Samba + Squid + squidGuard  com autenticação transparente NTLM (Active Directory) no Ubuntu 16.04.3 LTS" />
    <meta property="og:description" content="Acredito que qualquer organização que deixe o acesso à internet totalmente liberado para os seus colaboradores, além de perder em produtividade, está perdendo dinheiro. Até porque, tempo é dinheiro. Além disso, dependendo do ambiente da empresa, pode ser necessário filtrar o acesso dependendo do usuário, departamento e etc. Este é" />
    <meta property="og:url" content="https://lamasbr.github.io/2017/08/29/How-to-install-Samba-Squid-squid-Guard-using-NTLM-transparent-auth-Active-Directory-on-Ubuntu-16043-LTS.html" />
    <meta property="article:published_time" content="2017-08-29T00:00:00.000Z" />
    <meta property="article:tag" content="Linux" />
    <meta property="article:tag" content="Ubuntu" />
    <meta property="article:tag" content="Squid" />
    <meta property="article:tag" content="Samba" />
    <meta property="article:tag" content="squidGuard" />
    <meta property="article:tag" content="NTLM" />
    <meta property="article:tag" content="Active Directory" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Instalando e configurando Samba + Squid + squidGuard  com autenticação transparente NTLM (Active Directory) no Ubuntu 16.04.3 LTS" />
    <meta name="twitter:description" content="Acredito que qualquer organização que deixe o acesso à internet totalmente liberado para os seus colaboradores, além de perder em produtividade, está perdendo dinheiro. Até porque, tempo é dinheiro. Além disso, dependendo do ambiente da empresa, pode ser necessário filtrar o acesso dependendo do usuário, departamento e etc. Este é" />
    <meta name="twitter:url" content="https://lamasbr.github.io/2017/08/29/How-to-install-Samba-Squid-squid-Guard-using-NTLM-transparent-auth-Active-Directory-on-Ubuntu-16043-LTS.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Anotações para não esquecer",
    "author": {
        "@type": "Person",
        "name": "Lincoln Lamas",
        "image": "https://avatars1.githubusercontent.com/u/668513?v=4",
        "url": "https://lamasbr.github.io/author/lamasbr/",
        "sameAs": "http://lincolnlamas.com"
    },
    "headline": "Instalando e configurando Samba + Squid + squidGuard  com autenticação transparente NTLM (Active Directory) no Ubuntu 16.04.3 LTS",
    "url": "https://lamasbr.github.io/2017/08/29/How-to-install-Samba-Squid-squid-Guard-using-NTLM-transparent-auth-Active-Directory-on-Ubuntu-16043-LTS.html",
    "datePublished": "2017-08-29T00:00:00.000Z",
    "keywords": "Linux, Ubuntu, Squid, Samba, squidGuard, NTLM, Active Directory",
    "description": "Acredito que qualquer organização que deixe o acesso à internet totalmente liberado para os seus colaboradores, além de perder em produtividade, está perdendo dinheiro. Até porque, tempo é dinheiro. Além disso, dependendo do ambiente da empresa, pode ser necessário filtrar o acesso dependendo do usuário, departamento e etc. Este é"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="Anotações para não esquecer" href="https://lamasbr.github.io/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/styles/atom-one-dark.min.css">
    
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
</head>
<body class="post-template tag-Linux tag-Ubuntu tag-Squid tag-Samba tag-squid-Guard tag-NTLM tag-Active-Directory nav-closed">

    

    <div class="site-wrapper">

        


<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        
    </nav>
</header>

<main class="content" role="main">
    <article class="post tag-Linux tag-Ubuntu tag-Squid tag-Samba tag-squid-Guard tag-NTLM tag-Active-Directory">

        <header class="post-header">
            <h1 class="post-title">Instalando e configurando Samba + Squid + squidGuard  com autenticação transparente NTLM (Active Directory) no Ubuntu 16.04.3 LTS</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2017-08-29">29 August 2017</time>  on <a href="https://lamasbr.github.io/tag/Linux/">Linux</a>, <a href="https://lamasbr.github.io/tag/Ubuntu/">Ubuntu</a>, <a href="https://lamasbr.github.io/tag/Squid/">Squid</a>, <a href="https://lamasbr.github.io/tag/Samba/">Samba</a>, <a href="https://lamasbr.github.io/tag/squid-Guard/">squidGuard</a>, <a href="https://lamasbr.github.io/tag/NTLM/">NTLM</a>, <a href="https://lamasbr.github.io/tag/Active-Directory/">Active Directory</a>
            </section>
        </header>

        <section class="post-content">
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Acredito que qualquer organização que deixe o acesso à internet totalmente liberado para os seus colaboradores, além de perder em produtividade, está perdendo dinheiro. Até porque, tempo é dinheiro.</p>
</div>
<div class="paragraph">
<p>Além disso, dependendo do ambiente da empresa, pode ser necessário filtrar o acesso dependendo do usuário, departamento e etc. Este é o caso da empresa onde atualmente trabalho e devido a largura de banda ser pequena somado à quantidade de dispositivos na rede e usuários acessando simultaneamente, foi necessário bloquear o acesso à maioria dos sites desnecessários ao desempenho do trabalho dos colaboradores.</p>
</div>
<div class="paragraph">
<p>Para você ter chegado até aqui, acredito que já tenha o conhecimento necessário para instalar e configurar o Ubunto, utilizar editores de texto, visualizar logs e etc., pois não abordarei essas questões.</p>
</div>
<div class="paragraph">
<p>Depois de muito procurar uma configuração que de fato funcionasse e precisei juntar informações de diversos sites, resolvi guardar e publicar aqui para que, caso eu precise novamente no futuro ou alguém que também esteja passando pela mesma dificuldade que passei, possa utilizar como fonte de consulta. Enfim, vamos ao que interessa.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_detalhando_o_ambiente">Detalhando o ambiente</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Domínio Active Directory: dominio.local</p>
</li>
<li>
<p>Servidor Active Directory: ad.dominio.local / IP: 10.0.0.1</p>
</li>
<li>
<p>Servidor Samba/proxy: proxy.dominio.local / IP: 10.0.0.2</p>
</li>
<li>
<p>Usuário Administrador do domínio: dominio\administrador</p>
</li>
<li>
<p>Senha do usuário administrador do domínio: 123456</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adicione_o_servidor_samba_no_dns_do_active_directory">Adicione o servidor Samba no DNS do Active Directory</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para que a comunicação entre o Samba/Winbind e o Active Directory ocorra sem problemas, é necessário que você adicione o seu servidor Samba no DNS do seu Active Directory.</p>
</div>
<div class="paragraph">
<p>No seu controlador de domínio (ad.dominio.local), abra o console de gerenciamento do DNS, expanda a 'zona de pesquisa direta' e adicione a entrada do tipo 'Novo Host (A ou AAAA)' informando o nome como 'proxy' e o IP como '10.0.0.2'. <strong>Deixe marcado a opção para criar o registro PTR</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://lamasbr.github.io/images/post-images/How-to-install-Squid-squid-Guard-using-NTLM-transparent-auth-Active-Directory-on-Ubuntu-16043-LTS/dns-add-proxy01.png" alt="dns add proxy01.png">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://lamasbr.github.io/images/post-images/How-to-install-Squid-squid-Guard-using-NTLM-transparent-auth-Active-Directory-on-Ubuntu-16043-LTS/dns-add-proxy02.png" alt="dns add proxy02.png">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_atualizando_o_ubuntu">Atualizando o Ubuntu</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Antes de instalar qualquer pacote na sua distribuição, é necessário atualizar o repositório para garantir que os pacotes em sua ultima versão serão instalados corretamente e não irá gerar nenhum erro de dependência.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Atualize o Ubuntu com o comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@proxy~#: apt update ; apt upgrade</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_instalando_e_configurando_os_pacotes_b_sicos_e_necess_rios">Instalando e configurando os pacotes básicos e necessários</h3>
<div class="paragraph">
<p>Instale os pacotes necessários utilizando comando abaixo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@proxy~#: apt install squid squidguard telnet tcpdump ntpdate samba winbind vim tcpdump mc xz-utils rsync</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_edite_o_arquivo_etc_hosts">Edite o arquivo /etc/hosts</h4>
<div class="paragraph">
<p>Abra o arquivo /etc/hosts e ajuste o endereço do seu servidor proxy e seu servidor Active Directory nele:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>10.0.0.2	proxy.dominio.local	proxy
10.0.0.1	ad.dominio.local	ad</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_edite_o_arquivo_etc_samba_smb_conf">Edite o arquivo /etc/samba/smb.conf</h4>
<div class="paragraph">
<p>Abra o arquivo /etc/samba/smb.conf e deixe conforme a configuração abaixo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[global]
        unix charset = ISO-8859-1
        workgroup = DOMINIO
        server string = proxy
        netbios name = proxy
        log level = 5
        load printers = no
        log file = /var/log/samba/log.%m
        max log size = 500
        realm = DOMINIO.LOCAL
        security = ads
        auth methods = winbind
        password server = 10.0.0.1
        winbind separator = +
        encrypt passwords = yes
        printcap name = cups
        winbind cache time = 15
        winbind enum users = yes
        winbind enum groups = yes
        winbind use default domain = yes
        idmap uid = 10000-20000
        idmap gid = 10000-20000
        socket options = TCP_NODELAY SO_RCVBUF=8192 SO_SNDBUF=8192
        local master = no
        os level = 233
        domain master = no
        preferred master = no
        domain logons = no
        dns proxy = no
        ldap ssl = no
        printing = cups
        disable spoolss = yes
        show add printer wizard = no
        template shell = /bin/bash
        template homedir = /home/%U</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_inserindo_o_samba_no_dom_nio">Inserindo o Samba no domínio</h4>
<div class="paragraph">
<p>Insira o servidor Samba no domínio com o comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@proxy~#: net ads join -U dominio\administrador</code></pre>
</div>
</div>
<div class="paragraph">
<p>Insira a senha do administrador do domínio, neste exemplo é 123456.</p>
</div>
</div>
<div class="sect3">
<h4 id="_edite_o_arquivo_etc_init_d_winbind">Edite o arquivo /etc/init.d/winbind</h4>
<div class="paragraph">
<p>Modifique a linha 43 do arquivo /etc/init.d/winbind para que toda vez que inicie, modifique o grupo do diretório /var/run/samba/winbindd_privileged e /var/lib/samba/winbindd_privileged para root:proxy.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
No Ubuntu o usuário do Squid é 'proxy'.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">chown root:proxy $PIDDIR/winbindd_privileged/ || return 1
chown root:proxy /var/lib/samba/winbindd_privileged/ || return 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Altere a permissão do arquivo /usr/bin/ntlm_auth para que possa ser executado como root. Para isso, utilize o comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@proxy~#: chmod 6755 /usr/bin/ntlm_auth</code></pre>
</div>
</div>
<div class="paragraph">
<p>Então, reinicie o Samba e o Winbind com o comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@proxy~#: /etc/init.d/samba restart ; /etc/init.d/winbind restart</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testando_a_comunica_o_do_samba_winbind_com_o_servidor_active_directory">Testando a comunicação do Samba/Winbind com o servidor Active Directory</h3>
<div class="paragraph">
<p>Para assegurar que o seu servidor Samba/Winbind está comunicando perfeitamente com o servidor Active Directory, execute os comandos abaixo. Cada comando deverá retornar exatamente como exibido:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@proxy~#: wbinfo -t
checking the trust secret for domain DOMINIO via RPC calls succeeded</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">root@proxy~#: wbinfo -a administrador</code></pre>
</div>
</div>
<div class="paragraph">
<p>Será solicitada a senha do usuário administrador duas vezes e então deverá retornar a saída abaixo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>plaintext password authentication succeeded
challenge/response password authentication succeeded</code></pre>
</div>
</div>
<div class="paragraph">
<p>Caso tudo tenha ocorrido como esperado até aqui, prossiga para os próximos passos. Caso contrário, reveja as configurações pois algo pode ter passado despercebido ou algum arquivo ter sido configurado errado.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configurando_o_squid">Configurando o Squid</h3>
<div class="paragraph">
<p>A ESCREVER&#8230;&#8203;</p>
</div>
</div>
</div>
</div>
        </section>

        <footer class="post-footer">


            <figure class="author-image">
                <a class="img" href="https://lamasbr.github.io/author/lamasbr/" style="background-image: url(https://avatars1.githubusercontent.com/u/668513?v&#x3D;4)"><span class="hidden">Lincoln Lamas's Picture</span></a>
            </figure>

            <section class="author">
                <h4><a href="https://lamasbr.github.io/author/lamasbr/">Lincoln Lamas</a></h4>

                    <p>Read <a href="https://lamasbr.github.io/author/lamasbr/">more posts</a> by this author.</p>
                <div class="author-meta">
                    <span class="author-location icon-location">Juiz de Fora / BR</span>
                    <span class="author-link icon-link"><a href="http://lincolnlamas.com">http://lincolnlamas.com</a></span>
                </div>
            </section>


            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/intent/tweet?text=Instalando%20e%20configurando%20Samba%20%2B%20Squid%20%2B%20squidGuard%20%20com%20autentica%C3%A7%C3%A3o%20transparente%20NTLM%20(Active%20Directory)%20no%20Ubuntu%2016.04.3%20LTS&amp;url=https://lamasbr.github.io/2017/08/29/How-to-install-Samba-Squid-squid-Guard-using-NTLM-transparent-auth-Active-Directory-on-Ubuntu-16043-LTS.html"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://lamasbr.github.io/2017/08/29/How-to-install-Samba-Squid-squid-Guard-using-NTLM-transparent-auth-Active-Directory-on-Ubuntu-16043-LTS.html"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https://lamasbr.github.io/2017/08/29/How-to-install-Samba-Squid-squid-Guard-using-NTLM-transparent-auth-Active-Directory-on-Ubuntu-16043-LTS.html"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

        </footer>


        <section class="post-comments">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          var disqus_shortname = 'lamasbr'; // required: replace example with your forum shortname
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>


    </article>

</main>

<aside class="read-next">
</aside>



        <footer class="site-footer clearfix">
            <section class="copyright"><a href="https://lamasbr.github.io">Anotações para não esquecer</a> &copy; 2017</section>
            <section class="poweredby">Proudly published with <a href="http://hubpress.io">HubPress</a></section>
        </footer>

    </div>

    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();
      </script>

    <script type="text/javascript" src="//lamasbr.github.io/themes/casper/assets/js/jquery.fitvids.js?v=1504037300184"></script>
    <script type="text/javascript" src="//lamasbr.github.io/themes/casper/assets/js/index.js?v=1504037300184"></script>

</body>
</html>
