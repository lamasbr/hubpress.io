= Instalando e configurando Samba + Squid + squidGuard  com autenticação transparente NTLM (Active Directory) no Ubuntu 16.04.3 LTS
// :hp-image: /covers/cover.png
:published_at: 2017-08-29
:hp-tags: Linux, Ubuntu, Squid, Samba, squidGuard, NTLM, Active Directory
:hp-alt-title: How to install Squid + squidGuard using NTLM transparent auth (Active Directory) on Ubuntu 16.04.3 LTS

Acredito que qualquer organização que deixe o acesso à internet totalmente liberado para os seus colaboradores, além de perder em produtividade, está perdendo dinheiro. Até porque, tempo é dinheiro.

Além disso, dependendo do ambiente da empresa, pode ser necessário filtrar o acesso dependendo do usuário, departamento e etc. Este é o caso da empresa onde atualmente trabalho e devido a largura de banda ser pequena somado à quantidade de dispositivos na rede e usuários acessando simultaneamente, foi necessário bloquear o acesso à maioria dos sites desnecessários ao desempenho do trabalho dos colaboradores.

Para você ter chegado até aqui, acredito que já tenha o conhecimento necessário para instalar e configurar o Ubunto, utilizar editores de texto, visualizar logs e etc., pois não abordarei essas questões.

Depois de muito procurar uma configuração que de fato funcionasse e precisei juntar informações de diversos sites, resolvi guardar e publicar aqui para que, caso eu precise novamente no futuro ou alguém que também esteja passando pela mesma dificuldade que passei, possa utilizar como fonte de consulta. Enfim, vamos ao que interessa.

== Detalhando o ambiente

- Domínio Active Directory: dominio.local
- Servidor Active Directory: ad.dominio.local / IP: 10.0.0.1
- Servidor Samba/proxy: proxy.dominio.local / IP: 10.0.0.2

- Usuário Administrador do domínio: dominio\administrador
- Senha do usuário administrador do domínio: 123456

== Adicione o servidor Samba no DNS do Active Directory

Para que a comunicação entre o Samba/Winbind e o Active Directory ocorra sem problemas, é necessário que você adicione o seu servidor Samba no DNS do seu Active Directory. 

No seu controlador de domínio (ad.dominio.local), abra o console de gerenciamento do DNS, expanda a 'zona de pesquisa direta' e adicione a entrada do tipo 'Novo Host (A ou AAAA)' informando o nome como 'proxy' e o IP como '10.0.0.2'. *Deixe marcado a opção para criar o registro PTR*.

<INSERIR IMAGEM AQUI>

== Atualizando o Ubuntu

IMPORTANT: Antes de instalar qualquer pacote na sua distribuição, é necessário atualizar o repositório para garantir que os pacotes em sua ultima versão serão instalados corretamente e não irá gerar nenhum erro de dependência.

Atualize o Ubuntu com o comando:

[source,bash]
----
root@proxy~#: apt update ; apt upgrade
----

=== Instalando e configurando os pacotes básicos e necessários

Instale os pacotes necessários utilizando comando abaixo:

[source,bash]
----
root@proxy~#: apt install squid squidguard telnet tcpdump ntpdate samba winbind vim tcpdump mc xz-utils rsync
----

==== Edite o arquivo /etc/hosts

Abra o arquivo /etc/hosts e ajuste o endereço do seu servidor proxy e seu servidor Active Directory nele:
[source]
----
10.0.0.2	proxy.dominio.local	proxy
10.0.0.1	ad.dominio.local	ad
----

==== Edite o arquivo /etc/samba/smb.conf

Abra o arquivo /etc/samba/smb.conf e deixe conforme a configuração abaixo:

[source]
----
[global]
        unix charset = ISO-8859-1
        workgroup = DOMINIO
        server string = proxy
        netbios name = proxy
        log level = 5
        load printers = no
        log file = /var/log/samba/log.%m
        max log size = 500
        realm = DOMINIO.LOCAL
        security = ads
        auth methods = winbind
        password server = 10.0.0.1
        winbind separator = +
        encrypt passwords = yes
        printcap name = cups
        winbind cache time = 15
        winbind enum users = yes
        winbind enum groups = yes
        winbind use default domain = yes
        idmap uid = 10000-20000
        idmap gid = 10000-20000
        socket options = TCP_NODELAY SO_RCVBUF=8192 SO_SNDBUF=8192
        local master = no
        os level = 233
        domain master = no
        preferred master = no
        domain logons = no
        dns proxy = no
        ldap ssl = no
        printing = cups
        disable spoolss = yes
        show add printer wizard = no
        template shell = /bin/bash
        template homedir = /home/%U
----

==== Inserindo o Samba no domínio

Insira o servidor Samba no domínio com o comando:

[source,bash]
----
root@proxy~#: net ads join -U dominio\administrador
----

Insira a senha do administrador do domínio, neste exemplo é 123456.

==== Edite o arquivo /etc/init.d/winbind

Modifique a linha 43 do arquivo /etc/init.d/winbind para que toda vez que inicie, modifique o grupo do diretório /var/run/samba/winbindd_privileged e /var/lib/samba/winbindd_privileged para root:proxy. 

[TIP]
No Ubuntu o usuário do Squid é 'proxy'.

[source,bash]
----
chown root:proxy $PIDDIR/winbindd_privileged/ || return 1
chown root:proxy /var/lib/samba/winbindd_privileged/ || return 1
----

Altere a permissão do arquivo /usr/bin/ntlm_auth para que possa ser executado como root. Para isso, utilize o comando:

[source,bash]
----
root@proxy~#: chmod 6755 /usr/bin/ntlm_auth
----

Então, reinicie o Samba e o Winbind com o comando:

[source,bash]
----
root@proxy~#: /etc/init.d/samba restart ; /etc/init.d/winbind restart
----

=== Testando a comunicação do Samba/Winbind com o servidor Active Directory

Para assegurar que o seu servidor Samba/Winbind está comunicando perfeitamente com o servidor Active Directory, execute os comandos abaixo. Cada comando deverá retornar exatamente como exibido:

[source,bash]
----
root@proxy~#: wbinfo -t
checking the trust secret for domain DOMINIO via RPC calls succeeded
----

[source,bash]
----
root@proxy~#: wbinfo -a administrador
----

Será solicitada a senha do usuário administrador duas vezes e então deverá retornar a saída abaixo:

[source]
----
plaintext password authentication succeeded
challenge/response password authentication succeeded
----

Caso tudo tenha ocorrido como esperado até aqui, prossiga para os próximos passos. Caso contrário, reveja as configurações pois algo pode ter passado despercebido ou algum arquivo ter sido configurado errado.

=== Configurando o Squid

A ESCREVER...





